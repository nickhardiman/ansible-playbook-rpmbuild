---
# install packages, requires elevated privilege
- name: test
  hosts: rpmbuilder
  become: false
  gather_facts: false
  tasks:

  - ansible.builtin.set_fact:
      f_package: {}
  - ansible.builtin.set_fact:
      f_work_dir: /tmp/ansible.uj1apx62rpmbuild
      
  - name: Find the new RPM packages
    ansible.builtin.find:
      paths: "{{ f_work_dir }}"
      file_type: directory
      patterns: "*"
    register: r_find
  - debug:
      var: r_find['files']


  # shenanigans to get a list of names and versions
  #
  - name: empty package_names
    ansible.builtin.set_fact:
      f_dir_names: []

  # list package names
  - ansible.builtin.set_fact:
      f_dir_names: "{{ f_dir_names + [ item.path | basename ] }}"
    loop: "{{ r_find['files'] }}"
  - debug:
      var: f_dir_names

  - name: extract version line
    vars: 
      spec_file: "{{ f_work_dir + '/' + item + '/specs/' + item + '.spec' }}"
    ansible.builtin.shell:
      cmd: "grep -e '^Version:' {{ spec_file }}"
      #cmd: "grep -e '^Version:' {{ f_work_dir + '/' + item + '/specs/' + item + '.spec' }}"
    register: r_shell_grep
    loop: "{{ f_dir_names }}"
  - debug:
      var: r_shell_grep

 
  - name: empty f_line_version
    ansible.builtin.set_fact:
      f_line_version: []

  - name: build f_line_version
    ansible.builtin.set_fact:
      f_line_version: "{{ f_line_version + [{ 'name': item['item'], 'line': item['stdout'] }] }}"
    loop: "{{ r_shell_grep['results'] }}"
  - debug:
      var: f_line_version

  - name: empty f_spec_versions
    ansible.builtin.set_fact:
      f_spec_versions: []

  - name: build f_spec_versions
    vars:
      f_version: "{{ item['line'] | regex_replace('Version:\\s+(\\S+)', '\\1') }}"
    ansible.builtin.set_fact:
      f_spec_versions: "{{ f_spec_versions + [{ 'name': item['name'], 'version': f_version }] }}"
      #f_spec_versions: "{{ f_spec_versions + [{ 'name': item['name'], 'version': item['line'] | regex_replace('Version:\\s+(\\S+)', '\\1') }] }}"
    loop: "{{ f_line_version }}"
  - debug:
      var: f_spec_versions




